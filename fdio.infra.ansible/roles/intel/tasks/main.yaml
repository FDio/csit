---
# file: roles/performance_tuning/tasks/main.yaml

- name: Inst - Update Package Cache (APT)
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when:
    - ansible_distribution|lower == 'ubuntu'
  tags:
    - intel-inst-drivers

- name: Inst - Machine Prerequisites
  package:
    name: "{{ packages | flatten(levels=1) }}"
    state: latest
  tags:
    - intel-inst-drivers

- name: Inst - Check Presence of Intel Ethernet 810 Series
  shell: "lspci -d 8086:1592"
  register: intel_e810_pcis
  failed_when: no
  changed_when: no
  tags:
    - intel-inst-drivers

- name: Inst - Check Presence of Intel Ethernet 700 Series
  shell: "lspci -d 8086:1583; lspci -d 8086:1585; lspci -d 8086:1572"
  register: intel_700_pcis
  failed_when: no
  changed_when: no
  tags:
    - intel-inst-drivers

- name: Inst - Driver Intel Ethernet 810 Series
  import_tasks: ice.yaml
  when:
    - intel_e810_pcis.stdout_lines | length > 0
  tags:
    - intel-inst-drivers

#- name: Inst - Driver Intel Ethernet 700 Series
#  import_tasks: i40e.yaml
#  when:
#    - intel_700_pcis.stdout_lines | length > 0
#  tags:
#    - intel-inst-drivers

#- name: Inst - VF Driver Intel
#  import_tasks: iavf.yaml
#  when:
#    - intel_700_pcis.stdout_lines | length > 0 or intel_e810_pcis.stdout_lines | length > 0
#  tags:
#    - intel-inst-drivers
