---
# file: csit/tasks/main.yml

# General
- name: Adjust number of hugepages
  sysctl:
    name: 'vm.nr_hugepages'
    value: '512'
    state: 'present'
    sysctl_file: '/etc/sysctl.d/90-csit.conf'
    reload: 'yes'

- name: "Add user for running tests: {{ csit.test_user.name }}"
  user:
    name: '{{ csit.test_user.name }}'
    password: '{{ csit.test_user.password }}'
    home: '{{ csit.test_user.home }}'
    shell: '{{ csit.test_user.shell }}'

- name: Add vagrant user to docker group
  user:
    name: 'vagrant'
    groups:
      - 'docker'

- name: Reload groups for current session
  command: '/usr/bin/newgrp docker'

- name: Clone CSIT repository
  become_user: vagrant
  git:
    repo: '{{ csit.repository.url }}'
    dest: '{{ csit.home }}'
    accept_hostkey: yes
    version: '{{ csit.repository.version }}'

- name: Prepare python virtual environmant for CSIT
  become_user: vagrant
  command: '/usr/bin/virtualenv --python=/usr/bin/python3 {{ csit.home }}/env'
  args:
    chdir: '{{ csit.home }}'
    creates: '{{ csit.home }}/env/bin/activate'

- name: Install python dependencies (from {{ csit.home }}/requirements.txt)
  become_user: vagrant
  shell: |
      source '{{ csit.home }}/env/bin/activate' &&
      pip3 install --timeout 300 -r '{{ csit.home }}/requirements.txt'
  args:
    executable: '/bin/bash'

- name: Load csit docker image from local drive if it exists (/vagrant/csit-sut.tar)
  shell: |
    if [ -z "$(docker images -q `cat {{ csit.home }}/VPP_DEVICE_IMAGE`)" ] && [ -e /vagrant/csit-sut.tar ]; then
      docker load -i /vagrant/csit-sut.tar;
    fi;
  ignore_errors: yes
