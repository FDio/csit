---
# file: roles/iperf/tasks/main.yaml

- name: iPerf Install - Install Distribution - Release - Machine Prerequisites
  package:
    name: "{{ packages | flatten(levels=1) }}"
    state: latest
    update_cache: true
  tags:
    - install-dependencies

- name: iPerf Install - Get Release Archive
  get_url:
    url: "https://downloads.es.net/pub/iperf/iperf-{{ iperf_version }}.tar.gz"
    dest: "{{ iperf_target_dir }}/iperf-{{ iperf_version }}.tar.gz"
    mode: 0644
  tags:
    - install-iperf

- name: iPerf Install - Ensure Directory Exists
  file:
    path: "{{ iperf_target_dir }}/iperf-{{ iperf_version }}"
    state: "directory"
  tags:
    - install-iperf

- name: iPerf Install - Extract Release Archive
  unarchive:
    remote_src: true
    src: "{{ iperf_target_dir }}/iperf-{{ iperf_version }}.tar.gz"
    dest: "{{ iperf_target_dir }}/"
    creates: "{{ iperf_target_dir }}/iperf-{{ iperf_version }}/"
  tags:
    - install-iperf

- name: iPerf Install - Compile Release I
  shell: |
    cd "{{ iperf_target_dir }}/iperf-{{ iperf_version }}/" && ./configure && make && make install
  tags:
    - install-iperf
