---
# file: roles/aws/tasks/main.yaml

- name: AWS - Enable deb-src APT Repository
  apt_repository:
    repo: deb-src http://archive.ubuntu.com/ubuntu bionic main
    state: present
    update_cache: yes

- name: AWS - Get vfio-pci with WC patcher
  get_url:
    url: "https://github.com/amzn/amzn-drivers/raw/master/userspace/dpdk/enav2-vfio-patch/get-vfio-with-wc.sh"
    dest: "/opt/get-vfio-with-wc.sh"
    mode: "744"
  tags:
    - vfio-aws-patch

- name: AWS - Create vfio-pci patch directory
  file:
    path: "/opt/patches/"
    state: directory

- name: AWS - Get vfio-pci WC patch
  get_url:
    url: "https://github.com/amzn/amzn-drivers/raw/master/userspace/dpdk/enav2-vfio-patch/patches/linux-4.10-vfio-wc.patch"
    dest: "/opt/patches/linux-4.10-vfio-wc.patch"
    mode: "744"
  tags:
    - vfio-aws-patch

- name: AWS - Compile vfio-pci with WC patch
  shell: "/bin/bash /opt/get-vfio-with-wc.sh"
  tags:
    - vfio-aws-patch

- name: AWS - Load Kernel Modules By Default
  lineinfile:
    path: "/etc/modules"
    state: "present"
    line: "{{ item }}"
  with_items:
    - "vfio-pci"
    - "igb_uio"
  tags:
    - load-kernel-modules

- name: AWS - Add Kernel Modules Options (igb_uio)
  lineinfile:
    path: "/etc/modprobe.d/igb_uio.conf"
    state: "present"
    line: "{{ item }}"
    create: "yes"
  with_items:
    - "options igb_uio wc_activate=1"
  tags:
    - load-kernel-modules

- name: AWS - Add Kernel Modules Options (vfio-pci)
  lineinfile:
    path: "/etc/modprobe.d/vfio-noiommu.conf"
    state: "present"
    line: "{{ item }}"
    create: "yes"
  with_items:
    - "options vfio enable_unsafe_noiommu_mode=1"
  tags:
    - load-kernel-modules

- name: AWS - Reload systemd-modules
  systemd:
    name: "systemd-modules-load"
    state: "restarted"
  tags:
    - reload-systemd-modules

- name: AWS - Performance Tuning - Adjust nr_hugepages
  sysctl:
    name: "vm.nr_hugepages"
    value: "8192"
    state: "present"
    sysctl_file: "/etc/sysctl.d/90-csit.conf"
    reload: "yes"
  tags:
    - set-sysctl
