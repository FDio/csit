---
# file: roles/nomad/tasks/main.yaml

- name: Inst - Prerequisites
  package:
    name: "{{ packages | flatten(levels=1) }}"
    state: latest
    update_cache: true
  tags:
    - nomad-inst-prerequisites

- name: Conf - Add Nomad user
  user:
    name: "{{ nomad_user }}"
    group: "{{ nomad_group }}"
    groups: "{{ nomad_user_groups }}"
    state: "{{ nomad_user_state }}"
  when:
    - nomad_manage_user | bool
  tags:
    - nomad-conf-user

- name: Inst - Download Nomad
  get_url:
    url: "{{ nomad_zip_url }}"
    dest: "{{ nomad_inst_dir }}/{{ nomad_pkg }}"
  tags:
    - nomad-inst-package

- name: Inst - Unarchive Nomad
  unarchive:
    src: "{{ nomad_inst_dir }}/{{ nomad_pkg }}"
    dest: "{{ nomad_inst_dir }}/"
    creates: "{{ nomad_inst_dir }}/nomad"
    remote_src: true
  tags:
    - nomad-inst-package

- name: Inst - Nomad
  copy:
    src: "{{ nomad_inst_dir }}/nomad"
    dest: "{{ nomad_bin_dir }}"
    owner: "{{ nomad_user }}"
    group: "{{ nomad_group }}"
    mode: 0755
    remote_src: true
  tags:
    - nomad-inst-package

- name: Conf - Create directories
  file:
    dest: "{{ nomad_data_dir }}"
    state: directory
    owner: "{{ nomad_user }}"
    group: "{{ nomad_group }}"
  tags:
    - nomad-conf-dirs

- name: Conf - Create config directory
  file:
    dest: "{{ nomad_config_dir }}"
    state: directory
    owner: "{{ nomad_user }}"
    group: "{{ nomad_group }}"
    mode: 0755
  tags:
    - nomad-conf-dirs

- name: Conf - Base configuration
  template:
    src: base.hcl.j2
    dest: "{{ nomad_config_dir }}/base.hcl"
    owner: root
    group: root
    mode: 0644
  notify:
    - restart nomad

- name: Conf - Server configuration
  template:
    src: server.hcl.j2
    dest: "{{ nomad_config_dir }}/server.hcl"
    owner: root
    group: root
    mode: 0644
  when:
    - _nomad_node_server | bool
  notify:
    - restart nomad

- name: Conf - Client configuration
  template:
    src: client.hcl.j2
    dest: "{{ nomad_config_dir }}/client.hcl"
    owner: root
    group: root
    mode: 0644
  when:
    - _nomad_node_client | bool
  notify:
    - restart nomad

- name: Conf - Custom configuration
  template:
    src: custom.json.j2
    dest: "{{ nomad_config_dir }}/custom.json"
    owner: root
    group: root
    mode: 0644
  when:
    - nomad_config_custom is defined
  notify:
    - restart nomad
