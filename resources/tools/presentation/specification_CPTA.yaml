# Copyright (c) 2018 Cisco and/or its affiliates.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This is the specification of parameters for "Continuous Performance Trending
# and Analysis" feature provided by PAL.

-
  type: "environment"
  configuration:
    # Debug mode:
    # - Skip:
    #   - Download of input data files
    # - Do:
    #   - Read data from given zip / xml files
    #   - Set the configuration as it is done in normal mode
    # If the section "type: debug" is missing, CFG[DEBUG] is set to 0.
    CFG[DEBUG]: 1

  paths:
    # Top level directories:
    ## Working directory
    DIR[WORKING]: "_tmp"
    ## Build directories
    DIR[BUILD,HTML]: "_build"
    ## Static .rst files
    DIR[RST]: "../../../docs/cpta"

    # Static html content
    DIR[STATIC]: "{DIR[BUILD,HTML]}/_static"
    DIR[STATIC,VPP]: "{DIR[STATIC]}/vpp"
    # DIR[STATIC,DPDK]: "{DIR[STATIC]}/dpdk"
    DIR[STATIC,ARCH]: "{DIR[STATIC]}/archive"

    # Working directories
    ## Input data files (.zip, .xml)
    DIR[WORKING,DATA]: "{DIR[WORKING]}/data"
    ## Static source files from git
    DIR[WORKING,SRC]: "{DIR[WORKING]}/src"
    DIR[WORKING,SRC,STATIC]: "{DIR[WORKING,SRC]}/_static"

  urls:
    URL[JENKINS,CSIT]: "https://jenkins.fd.io/view/csit/job"

  make-dirs:
  # List the directories which are created while preparing the environment.
  # All directories MUST be defined in "paths" section.
  - "DIR[WORKING,DATA]"
  - "DIR[WORKING,SRC,STATIC]"
  - "DIR[BUILD,HTML]"
  - "DIR[STATIC,VPP]"
  # - "DIR[STATIC,DPDK]"
  - "DIR[STATIC,ARCH]"
  build-dirs:
  # List the directories where the results (build) is stored.
  # All directories MUST be defined in "paths" section.
  - "DIR[BUILD,HTML]"

-
  type: "configuration"

  data-sets:
# TODO: Specify input data, this is only an example:
    plot-performance-trending:
      csit-vpp-perf-mrr-daily-master:
        start: 1
        end: 5  # lastSuccessfulBuild  # take all from the start

  plot-layouts:
    plot-cpta:
      title: "VPP Performance Trend"
      autosize: False
      showlegend: True
      width: 700
      height: 700
      yaxis:
        showticklabels: True
        title: "Throughput [Mpps]"
        hoverformat: ".4s"
        range: []
        gridcolor: "rgb(238, 238, 238)"
        linecolor: "rgb(238, 238, 238)"
        showline: True
        zeroline: False
        tickcolor: "rgb(238, 238, 238)"
        linewidth: 1
        showgrid: True
      xaxis:
        showticklabels: True
        title: "Build number"
        autorange: True
        showgrid: True
        gridcolor: "rgb(238, 238, 238)"
        linecolor: "rgb(238, 238, 238)"
        fixedrange: False
        zeroline: False
        tickcolor: "rgb(238, 238, 238)"
        showline: True
        linewidth: 1
        autotick: True
      margin:
        r: 20
        b: 20
        t: 50
        l: 50
      legend:
        orientation: "h"
        traceorder: "normal"

-
  type: "debug"
  general:
    input-format: "xml"  # zip or xml
    extract: "robot-plugin/output.xml"  # Only for zip
  builds:
    # The files must be in the directory DIR[WORKING,DATA]
    csit-vpp-perf-mrr-daily-master:
    -
      build: 1
      file: "{DIR[WORKING,DATA]}/output_mrr_1.xml"
    -
      build: 2
      file: "{DIR[WORKING,DATA]}/output_mrr_2.xml"
    -
      build: 3
      file: "{DIR[WORKING,DATA]}/output_mrr_3.xml"
    -
      build: 4
      file: "{DIR[WORKING,DATA]}/output_mrr_4.xml"
    -
      build: 5
      file: "{DIR[WORKING,DATA]}/output_mrr_5.xml"

-
  type: "static"
  src-path: "{DIR[RST]}"
  dst-path: "{DIR[WORKING,SRC]}"

-
  type: "input"  # Ignored in debug mode
  general:
    file-name: "robot-plugin.zip"
    file-format: ".zip"
    download-path: "{job}/{build}/robot/report/*zip*/{filename}"
    extract: "robot-plugin/output.xml"
  builds:
    csit-vpp-perf-mrr-daily-master:
      start: 1
      end: "lastSuccessfulBuild"  # take all from the start

-
  type: "output"
  output:
#   "report"
    "CPTA"  # Continuous Performance Trending and Analysis
  format:
    html:
    - full
    pdf:
    - minimal

################################################################################
###                                 C P T A                                  ###
################################################################################

# Plots VPP Continuous Performance Trending and Analysis
-
  type: "cpta"
  title: "Continuous Performance Trending and Analysis"
  algorithm: "cpta"
  output-file-type: ".html"
  output-file: "{DIR[STATIC,VPP]}/cpmt"
  plots:
    - title: "L2"
      output-file-name: "l2"
      data: "plot-performance-trending"
      filter: "'MRR' and '64B' and ('BASE' or 'SCALE') and '1T1C' and ('L2BDMACSTAT' or 'L2BDMACLRN' or 'L2XCFWD') and not 'VHOST' and not 'MEMIF'"
      parameters:
      - "result"
      - "name"
      periods:
      - 1
      - 5
      - 30
      layout: "plot-cpta"

    - title: "ip4"
      output-file-name: "ip4"
      data: "plot-performance-trending"
      filter: "'MRR' and '64B' and ('BASE' or 'SCALE' or 'FEATURE') and '1T1C' and 'IP4FWD' and not 'IPSEC' and not 'VHOST'"
      parameters:
      - "result"
      - "name"
      periods:
      - 1
      - 5
      - 30
      layout: "plot-cpta"

    - title: "ip6"
      output-file-name: "ip6"
      data: "plot-performance-trending"
      filter: "'MRR' and '78B' and ('BASE' or 'SCALE' or 'FEATURE') and '1T1C' and 'IP6FWD' and not 'IPSEC' and not 'VHOST'"
      parameters:
      - "result"
      - "name"
      periods:
      - 1
      - 5
      - 30
      layout: "plot-cpta"

    - title: "Container memif l2"
      output-file-name: "container-memif-l2"
      data: "plot-performance-trending"
      filter: "'MRR' and '64B' and 'BASE' and '1T1C' and 'MEMIF' and ('L2BDMACSTAT' or 'L2BDMACLRN' or 'L2XCFWD') and not 'VHOST'"
      parameters:
      - "result"
      - "name"
      periods:
      - 1
      - 5
      - 30
      layout: "plot-cpta"
