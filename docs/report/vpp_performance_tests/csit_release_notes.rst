CSIT Release Notes
==================

Changes in CSIT |release|
-------------------------

#. VPP performance test environment changes

   - Further optimizations of VM and vhost-user test environment - various
     Qemu virtio queue size testing with value of 256 and 1024. Applied
     Linux CFS optimization to run VPP worker threads and Qemu worker threads
     with highest priority.

#. VPP performance test framework changes

   - Full code review, optimization and refactor.

#. T-rex changes

   - Full refactor of T-rex driver and introduce of traffic profiles that
     improves readability, manageability of traffic profiles for various
     test scenarios.

#. Added VPP performance tests

   - **LXC memif**

     - Memif interface tests interconnecting two VPP instances on single SUT.
       Master VPP instance running on native OS with Intel x520 NIC and guest
       VPP instance running in Linux Container (LXC) doing the L2 cross
       connect loop. LXC running in privileged mode is pinned to dedicated
       cores. All VPP instances are same version.

   - **Stateful Security Groups**

   - **VM vhost use cases**

Performance Improvements
------------------------

Substantial improvements in measured packet throughput have been
observed in a number of CSIT |release| tests listed below, with relative
increase  of double-digit percentage points. Relative improvements are
calculated against the test results listed in CSIT |release-1| report.
VPP-16.09 numbers are provided for reference.

NDR Throughput
~~~~~~~~~~~~~~

Non-Drop Rate Throughput discovery tests:

+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| VPP Functionality | Test Name                                                       | VPP-16.09 | VPP-17.01 | VPP-17.04 | VPP-17.07 | 17.04 to 17.07  |
|                   |                                                                 | [Mpps]    | [Mpps]    | [Mpps]    | [Mpps]    | Relative Change |
+===================+=================================================================+===========+===========+===========+===========+=================+
| L2XC-vhost-VM     | 10ge2p1x520: 64B-1t1c-eth-l2xcbase-eth-2vhost-1vm-ndrdisc       | 0.5       | 2.8       | 3.4       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2BD-vhost-VM     | 10ge2p1x520: 64B-1t1c-eth-l2bdbasemaclrn-eth-2vhost-1vm-ndrdisc | 0.4       | 2.7       | 3.1       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 vhost        | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-eth-2vhost-1vm-ndrdisc     | 0.3       | 2.6       | 3.0       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 LISP         | 10ge2p1x520: 64B-1t1c-ethip4lispip4-ip4base-ndrdisc             | 4.4       | 4.8       | 5.5       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6              | 10ge2p1x520: 78B-1t1c-ethip6-ip6base-ndrdisc                    | 3.0       | 7.3       | 8.1       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 COP          | 10ge2p1x520: 78B-1t1c-ethip6-ip6base-copwhtlistbase-ndrdisc     | 6.1       | 6.1       | 6.9       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 iAcl         | 10ge2p1x520: 78B-1t1c-ethip6-ip6base-iacldstbase-ndrdisc        | 6.5       | 6.1       | 6.9       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 FIB 2M       | 10ge2p1x520: 78B-1t1c-ethip6-ip6scale2m-ndrdisc                 | 5.3       | 4.2       | 4.6       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+

PDR Throughput
~~~~~~~~~~~~~~

Partial Drop Rate thoughput discovery tests with packet Loss Tolerance of 0.5%:

+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| VPP Functionality | Test Name                                                       | VPP-16.09 | VPP-17.01 | VPP-17.04 | VPP-17.07 | 17.04 to 17.07  |
|                   |                                                                 | [Mpps]    | [Mpps]    | [Mpps]    | [Mpps]    | Relative Change |
+===================+=================================================================+===========+===========+===========+===========+=================+
| L2XC-vhost-VM     | 10ge2p1x520: 64B-1t1c-eth-l2xcbase-eth-2vhost-1vm-pdrdisc       | 2.6       | 3.2       | 3.7       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2BD-vhost-VM     | 10ge2p1x520: 64B-1t1c-eth-l2bdbasemaclrn-eth-2vhost-1vm-pdrdisc | 2.1       | 2.9       | 3.3       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 vhost        | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-eth-2vhost-1vm-pdrdisc     | 2.0       | 2.7       | 3.0       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 LISP         | 10ge2p1x520: 64B-1t1c-ethip4lispip4-ip4base-pdrdisc             | 4.6       | 4.8       | 5.5       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6              | 10ge2p1x520: 78B-1t1c-ethip6-ip6base-pdrdisc                    | 7.7       | 7.3       | 8.1       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 COP          | 10ge2p1x520: 78B-1t1c-ethip6-ip6base-copwhtlistbase-pdrdisc     | 6.1       | 6.1       | 6.9       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 iAcl         | 10ge2p1x520: 78B-1t1c-ethip6-ip6base-iacldstbase-pdrdisc        | 6.5       | 6.1       | 6.9       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 FIB 2M       | 10ge2p1x520: 78B-1t1c-ethip6-ip6scale2m-pdrdisc                 | 5.3       | 4.2       | 4.6       |           | ??%             |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+

Measured improvements are in line with VPP code optimizations listed in
`VPP-17.07 release notes
<https://docs.fd.io/vpp/17.07/release_notes_1707.html>`_.

Other Performance Changes
-------------------------

Other changes in measured packet throughput, with either minor relative
increase or decrease, have been observed in a number of CSIT |release|
tests listed below. Relative changes are calculated against the test
results listed in CSIT |release-1| report.

NDR Throughput
~~~~~~~~~~~~~~

Non-Drop Rate Throughput discovery tests:

+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| VPP Functionality | Test Name                                                       | VPP-16.09 | VPP-17.01 | VPP-17.04 | VPP-17.07 | 17.04 to 17.07  |
|                   |                                                                 | [Mpps]    | [Mpps]    | [Mpps]    | [Mpps]    | Relative Change |
+===================+=================================================================+===========+===========+===========+===========+=================+
| L2XC              | 10ge2p1x520: 64B-1t1c-eth-l2xcbase-ndrdisc                      | 9.4       | 12.7      | 13.1      |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2XC              | 10ge2p1xl710: 64B-1t1c-eth-l2xcbase-ndrdisc                     | 9.5       | 12.2      | 12.4      |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2XC dot1ad       | 10ge2p1x520: 64B-1t1c-dot1ad-l2xcbase-ndrdisc                   | 7.4       | 8.8       | 9.3       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2XC dot1q        | 10ge2p1x520: 64B-1t1c-dot1q-l2xcbase-ndrdisc                    | 7.5       | 8.8       | 9.2       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2XC VxLAN        | 10ge2p1x520: 64B-1t1c-ethip4vxlan-l2xcbase-ndrdisc              | 5.4       | 6.5       | 6.8       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2BD              | 10ge2p1x520: 64B-1t1c-eth-l2bdbasemaclrn-ndrdisc                | 7.8       | 10.4      | 10.8      |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4              | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-ndrdisc                    | 8.7       | 9.7       | 10.6      |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 COP          | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-copwhtlistbase-ndrdisc     | 7.1       | 8.3       | 9.0       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 iAcl         | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-iacldstbase-ndrdisc        | 6.9       | 7.6       | 8.3       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 FIB 200k     | 10ge2p1x520: 64B-1t1c-ethip4-ip4scale200k-ndrdisc               | 8.5       | 9.0       | 9.7       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 FIB 20k      | 10ge2p1x520: 64B-1t1c-ethip4-ip4scale20k-ndrdisc                | 8.5       | 9.0       | 9.7       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 FIB 2M       | 10ge2p1x520: 64B-1t1c-ethip4-ip4scale2m-ndrdisc                 | 8.5       | 7.8       | 8.1       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 Policer      | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-ipolicemarkbase-ndrdisc    | 6.9       | 7.4       | 8.1       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 FIB 200k     | 10ge2p1x520: 78B-1t1c-ethip6-ip6scale200k-ndrdisc               | 6.5       | 5.3       | 5.3       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 FIB 20k      | 10ge2p1x520: 78B-1t1c-ethip6-ip6scale20k-ndrdisc                | 6.9       | 6.5       | 6.9       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+

PDR Throughput
~~~~~~~~~~~~~~

Partial Drop Rate thoughput discovery tests with packet Loss Tolerance of 0.5%:

+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| VPP Functionality | Test Name                                                       | VPP-16.09 | VPP-17.01 | VPP-17.04 | VPP-17.07 | 17.04 to 17.07  |
|                   |                                                                 | [Mpps]    | [Mpps]    | [Mpps]    | [Mpps]    | Relative Change |
+===================+=================================================================+===========+===========+===========+===========+=================+
| L2XC              | 10ge2p1x520: 64B-1t1c-eth-l2xcbase-pdrdisc                      | 9.4       | 12.7      | 13.4      |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2XC dot1ad       | 10ge2p1x520: 64B-1t1c-dot1ad-l2xcbase-pdrdisc                   | 7.4       | 8.8       | 9.3       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2XC dot1q        | 10ge2p1x520: 64B-1t1c-dot1q-l2xcbase-pdrdisc                    | 7.5       | 8.8       | 9.2       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2XC VxLAN        | 10ge2p1x520: 64B-1t1c-ethip4vxlan-l2xcbase-pdrdisc              | 5.4       | 6.5       | 6.8       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| L2BD              | 10ge2p1x520: 64B-1t1c-eth-l2bdbasemaclrn-pdrdisc                | 7.8       | 10.6      | 10.8      |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4              | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-pdrdisc                    | 8.7       | 9.7       | 10.6      |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 COP          | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-copwhtlistbase-pdrdisc     | 7.1       | 8.3       | 9.2       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 iAcl         | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-iacldstbase-pdrdisc        | 7.1       | 7.6       | 8.3       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 FIB 200k     | 10ge2p1x520: 64B-1t1c-ethip4-ip4scale200k-pdrdisc               | 8.5       | 9.0       | 9.7       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 FIB 20k      | 10ge2p1x520: 64B-1t1c-ethip4-ip4scale20k-pdrdisc                | 8.5       | 9.0       | 9.7       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 FIB 2M       | 10ge2p1x520: 64B-1t1c-ethip4-ip4scale2m-pdrdisc                 | 8.3       | 8.1       | 8.1       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv4 Policer      | 10ge2p1x520: 64B-1t1c-ethip4-ip4base-ipolicemarkbase-pdrdisc    | 7.1       | 7.4       | 8.1       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 FIB 200k     | 10ge2p1x520: 78B-1t1c-ethip6-ip6scale200k-pdrdisc               | 6.9       | 5.3       | 5.3       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+
| IPv6 FIB 20k      | 10ge2p1x520: 78B-1t1c-ethip6-ip6scale20k-pdrdisc                | 6.9       | 6.5       | 6.9       |           | ?%              |
+-------------------+-----------------------------------------------------------------+-----------+-----------+-----------+-----------+-----------------+

Known Issues
------------

Here is the list of known issues in CSIT |release| for VPP performance tests:

+---+-------------------------------------------------+------------+-----------------------------------------------------------------+
| # | Issue                                           | Jira ID    | Description                                                     |
+---+-------------------------------------------------+------------+-----------------------------------------------------------------+
| 1 | NDR discovery test failures 1518B frame size    | VPP-663    | VPP reporting errors: dpdk-input Rx ip checksum errors.         |
|   | for ip4scale200k, ip4scale2m scale IPv4 routed- |            | Observed frequency: all test runs.                              |
|   | forwarding tests. ip4scale20k tests are fine.   |            |                                                                 |
+---+-------------------------------------------------+------------+-----------------------------------------------------------------+
| 2 | Vic1385 and Vic1227 low performance.            | VPP-664    | Low NDR performance.                                            |
|   |                                                 |            |                                                                 |
+---+-------------------------------------------------+------------+-----------------------------------------------------------------+
| 3 | Sporadic NDR discovery test failures on x520.   | CSIT-750   | Suspected issue with HW settings (BIOS, FW) in LF               |
|   |                                                 |            | infrastructure. Issue can't be replicated outside LF.           |
+---+-------------------------------------------------+------------+-----------------------------------------------------------------+
| 4 | VPP in 2t2c setups - large variation            | CSIT-568   | Suspected NIC firmware or DPDK driver issue affecting NDR       |
|   | of discovered NDR throughput values across      |            | throughput. Applies to XL710 and X710 NICs, x520 NICs are fine. |
|   | multiple test runs with xl710 and x710 NICs.    |            |                                                                 |
+---+-------------------------------------------------+------------+-----------------------------------------------------------------+
| 5 | Lower than expected NDR and PDR throughput with | CSIT-569   | Suspected NIC firmware or DPDK driver issue affecting NDR and   |
|   | xl710 and x710 NICs, compared to x520 NICs.     |            | PDR throughput. Applies to XL710 and X710 NICs.                 |
+---+-------------------------------------------------+------------+-----------------------------------------------------------------+

