## CSIT-1908 VPP Performance Analysis on 2n-skx Testbeds

## Scope

This note provides analysis of FD.io *CSIT-1908* benchmarking data
generated by jobs executing performance tests of *VPP v19.08* on FD.io
*2-node Skylake* physical testbeds.

All identified throughput regressions and progressions between
*CSIT-1908* release and previous release(s) are examined, listing
associated root cause analyses and resolutions (when applicable).

## References

- Latest CSIT-1908 report data
  - https://docs.fd.io/csit/master/report/_static/vpp/performance-changes-2n-skx-2t1c-ndr.txt
  - https://docs.fd.io/csit/master/report/_static/vpp/performance-changes-2n-skx-2t1c-pdr.txt

## Analysis - Throughput Regressions

### vpp l2bd

1. 64B NDR drop by (-10% to -1%)

test                             | rls19.04 [pps] | rls19.08 [pps]
---------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn      | 18.31          | 17.96
64b-2t1c-eth-l2bdscale10kmaclrn  | 13.57          | 12.87
64b-2t1c-eth-l2bdscale100kmaclrn | 12.02          | 11.08
64b-2t1c-eth-l2bdscale1mmaclrn   | 11.63          | 10.37

2. 64B PDR drop by (-10% to -2%)

test                             | rls19.04 [pps] | rls19.08
---------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn      | 18.77          | 18.16
64b-2t1c-eth-l2bdscale10kmaclrn  | 13.79          | 13.29
64b-2t1c-eth-l2bdscale100kmaclrn | 12.17          | 11.47
64b-2t1c-eth-l2bdscale1mmaclrn   | 11.82          | 10.63

3. root cause analysis
  - suspected cause: vpp binary code change affecting throughput
  - source: CSIT daily MRR trending
    - https://docs.fd.io/csit/master/trending/trending/l2-2n-skx-xxv710-64b-base-scale.html
    - https://docs.fd.io/csit/master/trending/trending/l2-2n-skx-x710-64b-base-scale.html
  - detected throughput regressions between vpp builds:
    - vpp-19.08-rc0-508-g398afbd88
    - vpp-19.08-rc0-525-g023d23ad8
    - vpp-19.08-rc0-573-g6898e5cb8

4. resolution
  - VPP code bisecting: TODO
  - report update: TODO

### vpp dot1q

1. 64B NDR drop by -11%

test                             | rls19.04 [pps] | rls19.08 [pps]
---------------------------------|----------------|---------------
64b-2t1c-dot1q-l2bdbasemaclrn    | 13.37          | 11.7

2. 64B PDR drop by -10%

test                             | rls19.04 [pps] | rls19.08 [pps]
---------------------------------|----------------|---------------
64b-2t1c-dot1q-l2bdbasemaclrn    | 14.8           | 12.9

3. root cause analysis
  - verified cause: csit code change, test methodology change
    - was: asymmetric dot1q (one link untagged, one link dot1q)
    - is: symmetric dotq (both links to trex dot1q)

4. resolution
  - report updates
    - TODO (Tibor Frank) do not calculate delta [%], instead insert a marker
      (pointer) to explanation in rls notes e.g. "changed methodology
      see relnotes"
    - TODO (Maciek)/(Peter Mikus) update release notes

### vpp vhost

1. 64B NDR drop by (-51% to -25%)

test                                             | rls19.04 [pps] | rls19.08 [pps]
-------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2xcbase-eth-2vhostvr1024-1vm       | 7.29           | 5.48
64b-2t1c-eth-l2bdbasemaclrn-eth-2vhostvr1024-1vm | 5.78           | 2.8
64b-2t1c-ethip4-ip4base-eth-2vhostvr1024-1vm     | 6.46           | 3.43

2. 64B PDR drop by (-24% to -13%)

test                                             | rls19.04 [pps] | rls19.08 [pps]
-------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2xcbase-eth-2vhostvr1024-1vm       | 7.72           | 6.86
64b-2t1c-eth-l2bdbasemaclrn-eth-2vhostvr1024-1vm | 6.05           | 5.0
64b-2t1c-ethip4-ip4base-eth-2vhostvr1024-1vm     | 6.51           | 5.0

3. root cause analysis
  - verified cause: csit code change, test methodology change
    - was: testpmd in vm
    - is: vppip4 in vm

4. resolution
  - csit code updates:
    - TODO (Peter Mikus) rename above tests to s/-1vm/-1vm-vppip4/, as these are
      new tests
    - TODO (Peter Mikus) add tests with testpmd in vm as per previous releases
      using above names for comparison consistency
  - report updates:
    - TODO (Tibor Frank) calculate comparison deltas for "-1vm" tests as per usual
    - TODO (Tibor Frank) add new tests "-1vm-vppip4" at the top of the table
      - mark them as "data not present", or similar, in previous
        releases, in [delta[%]] column list "n/a", or "new"
    - TODO (Tibor Frank) IMPORTANT NOTE: all tests from select-list must be listed
      in comparison tables, even if they were not selectively tested in
      the previous releases
      - Currently number of tests are missing from comparison tables
        e.g. ipsec

### vpp dot1q and vhost/memif

1. 64B NDR drop by (-46% to -12%)

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-dot1q-l2bdbasemaclrn                      | 13.37          | 11.7
64b-2t1c-dot1q-l2bdbasemaclrn-eth-2memif-1dcr      | 5.39           | 4.7
64b-2t1c-dot1q-l2bdbasemaclrn-eth-2vhostvr1024-1vm | 5.38           | 2.9

2. 64B PDR drop by (-27% to -8%)

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-dot1q-l2bdbasemaclrn                      | 14.8           | 12.9
64b-2t1c-dot1q-l2bdbasemaclrn-eth-2memif-1dcr      | 6.25           | 5.72
64b-2t1c-dot1q-l2bdbasemaclrn-eth-2vhostvr1024-1vm | 6.53           | 4.72

3. root cause analysis
  - verified cause1: csit code change, test methodology change
    - was: asymmetric dot1q (one link untagged, one link dot1q)
    - is: symmetric dotq (both links to trex dot1q)
  - verified cause2 (vm only): csit code change, test methodology change
    - was: testpmd in vm
    - is: vppip4 in vm

4. resolution
  - report updates
    - TODO (Tibor Frank) do not calculate delta [%], instead insert a marker
      (pointer) to explanation in rls notes e.g. "changed methodology
      see relnotes"
    - TODO (Maciek)/(Peter Mikus) update release notes


### vpp iacl50sf

1. 64B NDR drop by -16%

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-ethip4udp-ip4base-iacl50sf-10kflows       | 10.97          | 9.16

2. 64B PDR drop by -15%

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-ethip4udp-ip4base-iacl50sf-10kflows       | 11.27          | 9.48

3. root cause analysis
  - suspected cause: vpp binary code change affecting throughput
  - source: CSIT daily MRR trending
    - https://docs.fd.io/csit/master/trending/trending/ip4-2n-skx-x710-64b-features.html
  - detected throughput regressions between vpp builds:
    - no data for the period

4. resolution
  - VPP code bisecting: TODO
  - report update: TODO

## Analysis - Throughput Progressions

### vpp memif

1. 64B NDR rise by 9%

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn-eth-2memif-1dcr        | 5.84           | 6.41

2. 64B PDR rise by 7%

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn-eth-2memif-1dcr        | 6.01           | 6.45

3. root cause analysis
  - suspected cause: vpp binary code change affecting throughput
  - source: CSIT daily MRR trending
    - https://docs.fd.io/csit/master/trending/trending/container_memif-2n-skx-x710-64b-base.html
  - detected throughput progressions between vpp builds:
    - a number of progressions and regressions

4. resolution
  - no action needed
