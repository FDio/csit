## CSIT-1908 VPP Performance Analysis on 3n-skx Testbeds

## Scope

This note provides analysis of FD.io *CSIT-1908* benchmarking data
generated by jobs executing performance tests of *VPP v19.08* on FD.io
*3-node Skylake* physical testbeds.

All identified throughput regressions and progressions between
*CSIT-1908* release and previous release(s) are examined, listing
associated root cause analyses and resolutions (when applicable).

## References

- Latest CSIT-1908 report data
  - https://docs.fd.io/csit/master/report/_static/vpp/performance-changes-3n-skx-2t1c-ndr.txt
  - https://docs.fd.io/csit/master/report/_static/vpp/performance-changes-3n-skx-2t1c-pdr.txt

## New tests for comparison in CSIT-1908

Number of new tests have been added in CSIT-1908 for comparison between
releases. Following convention is used in comparison table for all new
tests in CSIT-1908 that are not present in previous releases:

- data fields for releases without results:
  - old text: None
  - new text: Not tested
- Delta field:
  - old text: n/a
  - new text: New in CSIT-1908

## Analysis - Throughput Regressions

### vpp l2bd

1. NDR drop by (-3% to -1%)

test                             | rls19.04 [pps] | rls19.08 [pps]
---------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn      | 18.21          | 18.00
64b-2t1c-eth-l2bdscale10kmaclrn  | 13.36          | 12.75
64b-2t1c-eth-l2bdscale100kmaclrn | 11.72          | 11.36
64b-2t1c-eth-l2bdscale1mmaclrn   | 10.96          | 10.59

2. PDR drop by (-2% to -1%)

test                             | rls19.04 [pps] | rls19.08 [pps]
---------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn      | 18.52          | 18.09
64b-2t1c-eth-l2bdscale10kmaclrn  | 13.47          | 13.21
64b-2t1c-eth-l2bdscale100kmaclrn | 11.88          | 11.67
64b-2t1c-eth-l2bdscale1mmaclrn   | 11.14          | 10.89

3. root cause analysis
  - suspected cause: vpp binary code change affecting throughput
  - source: CSIT daily MRR trending
    - https://docs.fd.io/csit/master/trending/trending/l2-3n-skx-x710-64b-base-scale.html
  - detected throughput regressions between vpp builds:
    - vpp-19.08-rc0-525-g023d23ad8
    - vpp-19.08-rc0-560-g6898e5cb8

4. resolution
  - VPP code bisecting: TODO
  - report update: TODO

### vpp vhost

1. NDR drop by (-71% to -%52)

test                                                          | rls19.04 [pps] | rls19.08 [pps]
--------------------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2xcbase-eth-2vhostvr1024-1vm                    | 7.19           | 3.42
64b-2t1c-eth-l2bdbasemaclrn-eth-2vhostvr1024-1vm              | 5.68           | 1.81
64b-2t1c-ethip4-ip4base-eth-2vhostvr1024-1vm                  | 6.47           | 2.18
64b-2t1c-dot1q-l2xcbase-eth-2vhostvr1024-1vm                  | 5.82           | 2.83
64b-2t1c-dot1q-l2bdbasemaclrn-eth-2vhostvr1024-1vm            | 4.95           | 1.72
64b-2t1c-1lbvpplacp-dot1q-l2bdbasemaclrn-eth-2vhostvr1024-1vm | 5.26           | 1.52
64b-2t1c-1lbvpplacp-dot1q-l2xcbase-eth-2vhostvr1024-1vm       | 6.37           | 2.58
64b-2t1c-ethip4vxlan-l2bdbasemaclrn-eth-2vhostvr1024-1vm      | 4.66           | 1.52


2. PDR drop by (-22% to -11%)

test                                                          | rls19.04 [pps] | rls19.08 [pps]
--------------------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2xcbase-eth-2vhostvr1024-1vm                    | 7.66           | 6.63
64b-2t1c-eth-l2bdbasemaclrn-eth-2vhostvr1024-1vm              | 5.99           | 5.13
64b-2t1c-ethip4-ip4base-eth-2vhostvr1024-1vm                  | 6.48           | 5.05
64b-2t1c-dot1q-l2xcbase-eth-2vhostvr1024-1vm                  | 7.20           | 5.76
64b-2t1c-dot1q-l2bdbasemaclrn-eth-2vhostvr1024-1vm            | 5.83           | 4.80
64b-2t1c-1lbvpplacp-dot1q-l2bdbasemaclrn-eth-2vhostvr1024-1vm | 5.30           | 4.56
64b-2t1c-1lbvpplacp-dot1q-l2xcbase-eth-2vhostvr1024-1vm       | 6.41           | 5.54
64b-2t1c-ethip4vxlan-l2bdbasemaclrn-eth-2vhostvr1024-1vm      | 4.69           | 4.14

3. root cause analysis
  - verified cause: csit code change, test methodology change
    - was: testpmd in vm
    - is: vppip4/vppl2xc/vppl2bd/ in vm

4. resolution
  - csit code updates:
    - TODO (Peter Mikus) rename above tests to reflect vpp configuration
      in vm e.g. s/1vm/1vm-vppip4/ for ip4base tests, s/1vm/1vm-vppl2xc/
      for l2xc and l2bd tests, as these are new tests
    - TODO (Peter Mikus) add tests with testpmd in vm as per previous
      releases using above names for comparison consistency
  - report updates:
    - TODO (Tibor Frank) calculate comparison deltas for "-1vm" tests as
      per usual
    - TODO (Tibor Frank) add new tests "-1vm-vppip4", "-1vm-vppl2xc",
      at the top of the table as the new tests.
    - TODO (Tibor Frank) IMPORTANT NOTE: all tests from select-list must
      be listed in comparison tables, even if they were not selectively
      tested in the previous releases
      - Currently number of tests are missing from comparison tables
        e.g. ipsec

### vpp iacl50sf iacl50sl

1. NDR drop by (-14% to -2%)

test                                          | rls19.04 [pps] | rls19.08 [pps]
----------------------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn-iacl50sl-10kflows | 8.96           | 8.73
64b-2t1c-eth-l2bdbasemaclrn-iacl50sf-10kflows | 10.21          | 8.71
64b-2t1c-ethip4udp-ip4base-iacl50sf-10kflows  | 10.96          | 9.42

2. PDR drop by (-16% to -4%)

test                                          | rls19.04 [pps] | rls19.08 [pps]
----------------------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn-iacl50sl-10kflows | 9.15           | 8.73
64b-2t1c-eth-l2bdbasemaclrn-iacl50sf-10kflows | 10.47          | 8.74
64b-2t1c-ethip4udp-ip4base-iacl50sf-10kflows  | 11.24          | 9.67

3. root cause analysis
  - suspected cause: vpp binary code change affecting throughput
  - source: CSIT daily MRR trending
    - https://docs.fd.io/csit/master/trending/trending/l2-3n-skx-x710-64b-features.html
    - https://docs.fd.io/csit/master/trending/trending/ip4-3n-skx-x710-64b-features.html
  - detected throughput regressions between vpp builds:
    - no data for the period

4. resolution
  - VPP code bisecting: TODO
  - report update: TODO

## Analysis - Throughput Progressions

### vpp memif

1. NDR rise by 18%

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn-eth-2memif-1lxc        | 5.44           | 6.47

2. PDR rise by 9%

test                                               | rls19.04 [pps] | rls19.08 [pps]
---------------------------------------------------|----------------|---------------
64b-2t1c-eth-l2bdbasemaclrn-eth-2memif-1lxc        | 5.95           | 6.49

3. root cause analysis
  - suspected cause: vpp binary code change affecting throughput
  - source: CSIT daily MRR trending
    - https://docs.fd.io/csit/master/trending/trending/container_memif-3n-skx-x710-64b-base.html
  - detected throughput progressions between vpp builds:
    - a number of progressions and regressions

4. resolution
  - no action needed
